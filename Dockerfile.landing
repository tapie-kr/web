FROM node:23-bookworm-slim AS builder

COPY packages/tapie /app/packages/tapie
COPY packages/shared /app/packages/shared
COPY packages/tapie/pnpm-workspace.yaml /app/packages/tapie/pnpm-workspace.yaml
COPY packages/tapie/pnpm-lock.yaml /app/packages/tapie/pnpm-lock.yaml

WORKDIR /app/packages/tapie

ENV time_zone=Asia/Seoul

RUN corepack enable
RUN corepack prepare pnpm@9.15.1 --activate
# devDependencies도 설치하기 위해 --prod=false 명시
RUN pnpm install --frozen-lockfile --prod=false

ENV NEXT_PUBLIC_API_URL=https://api.tapie.kr
ENV API_HOSTNAME=https://api.tapie.kr
ENV API_VERSION=v1
ENV AUTH_URL=https://auth.tapie.kr

FROM builder AS production

WORKDIR /app/packages/tapie

ENV NODE_ENV=production
RUN pnpm build

ENV PORT=3000
EXPOSE 3000

CMD ["pnpm", "start"]